name: CI

on:
  # Trigger on PR creation and updates
  pull_request:
    branches: [ main, develop ]

  # Trigger on merge to main
  push:
    branches: [ main ]

  # Trigger on manual dispatch
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run against'
        required: false
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.3.x'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify Bun installation
        run: |
          bun --version
          make --version

      - name: Run CI pipeline
        run: make ci

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.sha }}
          path: coverage/
          retention-days: 7

      - name: Upload binary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cia-binary-${{ github.sha }}
          path: dist/cia
          retention-days: 7

  # Additional job for E2E tests (only runs on manual dispatch with production environment)
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production' }}
    needs: ci
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.3.x'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run E2E tests
        run: RUN_E2E_TESTS=1 bun test packages/cli/src/e2e.test.ts
        env:
          # Add environment variables for E2E tests if needed
          CI: true

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ github.sha }}
          path: test-results/
          retention-days: 3