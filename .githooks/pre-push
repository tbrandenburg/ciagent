#!/usr/bin/env sh
# Lightweight pre-push hook - fast essential validation only
# Target: complete in under 30 seconds
set -eu

cd "$(git rev-parse --show-toplevel)"

echo "[cia] ğŸš€ running pre-push validation (targeting <30s)"
start_time=$(date +%s)

# Function to show elapsed time
show_elapsed() {
    local current_time=$(date +%s)
    local elapsed=$((current_time - start_time))
    echo "[cia] â±ï¸  ${elapsed}s elapsed"
}

# Trap to show final time on exit
trap 'show_elapsed' EXIT

# 1. FAST: Type checking (~3-5s)
echo "[cia] ğŸ” type checking..."
timeout 15 bun run type-check || {
    echo "[cia] âŒ type check failed or timed out (15s limit)"
    exit 1
}
show_elapsed

# 2. FAST: Linting (~2-3s) 
echo "[cia] ğŸ§¹ linting..."
timeout 10 bun run lint || {
    echo "[cia] âŒ lint failed or timed out (10s limit)"
    exit 1
}
show_elapsed

# 3. SMOKE: Critical path tests only (~10-15s)
# Run only core functionality tests, skip slow integration tests
echo "[cia] ğŸ§ª smoke tests (critical path only)..."
timeout 20 npx vitest --run packages/cli/tests/cli.test.ts packages/cli/tests/commands/help.test.ts packages/cli/tests/commands/version.test.ts packages/cli/tests/config/loader.test.ts || {
    echo "[cia] âŒ smoke tests failed or timed out (20s limit)"
    echo "[cia] ğŸ’¡ run 'make test' locally to see detailed failures"
    exit 1
}
show_elapsed

# 4. OPTIONAL: Basic build smoke test (skip if running long)
current_time=$(date +%s)
elapsed=$((current_time - start_time))

if [ $elapsed -lt 25 ]; then
    echo "[cia] ğŸ”¨ build smoke test..."
    timeout 10 bun run build >/dev/null 2>&1 || {
        echo "[cia] âš ï¸  build smoke test failed (non-blocking)"
        echo "[cia] ğŸ’¡ run 'make build' locally to debug"
        # Don't exit - build issues aren't blocking for push
    }
    show_elapsed
else
    echo "[cia] â­ï¸  skipping build test (time budget: ${elapsed}s/30s used)"
fi

final_time=$(date +%s)
total_elapsed=$((final_time - start_time))

if [ $total_elapsed -ge 30 ]; then
    echo "[cia] âš ï¸  validation took ${total_elapsed}s (target: <30s) - consider optimizing"
else
    echo "[cia] âœ… validation complete in ${total_elapsed}s"
fi

echo "[cia] ğŸ‰ pre-push validation passed - ready to push!"
